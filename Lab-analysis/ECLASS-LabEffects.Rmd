---
output:
  pdf_document: default
  html_document: default
---
# Load necessary packages
```{r, results = 'hide', message = FALSE, warning = FALSE}
library(easypackages)
libraries('tidyverse', 'data.table', 'reshape2', 'ggpubr', 'lmerTest', 
          'reghelper', 'car', 'lattice', 'sjstats', 'sjPlot', 'gridExtra', 
          'stargazer', 'lavaan', 'semPlot', 'psych', 'grid')
theme_set(theme_classic(base_size = 12)) # set font size for ggplot
```

# Scoring/cleaning functions
```{r}
Read.Score <- function(file){
  # read master E-CLASS file and calculate total scores on student and expert questions
  dt <- fread(file)
  
  # columns with students responses end in a (student Qs) or b (expert Qs)...get those
  answers.cols <- names(dt)[grep('(a|b)$', names(dt))]
  
  # correct answers marked as 5, incorrect as 1, and neutral as 0...map to +/- 1 and 0
  dt[, (answers.cols) := lapply(.SD, function(x) case_when(x == 5 ~ 1,
                                                           x == 1 ~ -1,
                                                           TRUE ~ 0)),
     .SDcols = answers.cols]
  df <- dt[, -c('q40a', 'q40b')] # q40 was a filter question, no part of scoring

  # sum student/expert scores
  df$student.score <- rowSums(df %>% select(grep("a$", names(.))))
  df$expert.score <- rowSums(df %>% select(grep("b$", names(.))))
  
  return(df)
}
```

# Read, score, and match
```{r}
# read course information survey (CIS) and pre/post survey data
cis.df <- read.csv('C:/Users/Cole/Documents/GRA_Summer2020/eclass-public-analysis/anon_cis_CW.csv')
pre.df <- Read.Score('C:/Users/Cole/Documents/GRA_Summer2020/eclass-public-analysis/anon_pre.csv')

# join CIS on presurvey
cis.pre.df <- right_join(cis.df, pre.df, by = c('pre_survey_id' = 'survey_id'), 
                         suffix = c('.CIS', '.pre'))
post.df <- Read.Score('C:/Users/Cole/Documents/GRA_Summer2020/eclass-public-analysis/anon_post.csv')

# join presurveys (with CIS) on postsurveys...full join keeps unmatched surveys
full.df <- full_join(cis.pre.df, post.df, by = c('post_survey_id' = 'survey_id', 
                                                 'anon_student_id'), 
                     suffix = c('.pre', '.post'))

# mutate lab type and course level info from CIS
full.df <- full.df %>%
    mutate(Lab.type = case_when(
      Q33 == 'Reinforce physics concepts.' ~ 'Concepts-based',
      Q33 == 'Both about equally.' ~ 'Mixed',
      Q33 == 'Develop lab skills.' ~ 'Skills-based',
      TRUE ~ NA_character_
    ), 
    Course.level = case_when(
      Q18 == 'Beyond the first year lab' ~ 'BFY',
      (Q27 == 'Calculus-based') | (Q27 == 'Algebra-based') ~ 'FY',
      TRUE ~ NA_character_
    ))

full.df <- data.table(full.df)[, `:=`(N.students = .N, 
                                      pre.rate = sum(!is.na(student.score.pre))/.N,
                                      post.rate = sum(!is.na(student.score.post))/.N), 
                               .(ResponseId.CIS)] %>%
  data.frame()

# remove whole classes without type and/or level information
complete.df <- full.df %>%
  filter(!is.na(Lab.type) & !is.na(Course.level) & (pre.rate > 0) & 
           (post.rate > 0))

# get matched dataset
df.matched <- complete.df %>%
  filter(!is.na(student.score.pre) & !is.na(student.score.post))

data.frame(N.student.records = unlist(lapply(list(full.df, complete.df, 
                                                  df.matched), 
                                             function(x) nrow(x))),
           N.students = unlist(lapply(list(full.df, complete.df, df.matched), 
                                      function(x) length(unique(x[,                                                                  'anon_student_id'])))),
           N.classes = unlist(lapply(list(full.df, complete.df, df.matched), 
                                     function(x) length(unique(x[,                                                                 'ResponseId.CIS'])))),
           N.institutions = unlist(lapply(list(full.df, complete.df, df.matched),
                                          function(x) length(unique(x[,                                                                     'anon_university_id'])))),
           row.names = c('full dataset', 'course info', 'matched'))

# Breakdown of institution type, course level, and lab type
table(df.matched[!duplicated(df.matched$anon_university_id),]$Q15, exclude = NULL)
table(df.matched[!duplicated(df.matched$ResponseId.CIS),]$Course.level, 
      exclude = NULL)
table(df.matched[!duplicated(df.matched$ResponseId.CIS),]$Lab.type, exclude = NULL)
```

# Data processing
```{r}
# replace declared major with intended major in cases where students intend to switch
df.matched[is.na(df.matched$Q48) | (df.matched$Q48 == 0),
           'Q48'] <- df.matched[is.na(df.matched$Q48) | (df.matched$Q48 == 0), 
                                'Q47']

# mutate and combine categories
df.matched <- df.matched %>%
  mutate(Major = case_when(
    Q48 == 1 ~ 'Physics',
    Q48 == 2 ~ 'Chemistry',
    Q48 == 3 ~ 'Biochemistry',
    Q48 == 4 ~ 'Biology',
    Q48 == 5 ~ 'Engineering',
    Q48 == 6 ~ 'Engineering Physics',
    Q48 == 7 ~ 'Astronomy',
    Q48 == 8 ~ 'Astrophysics',
    Q48 == 9 ~ 'Geology/geophysics',
    Q48 == 10 ~ 'Math/applied math',
    Q48 == 11 ~ 'Computer science',
    Q48 == 12 ~ 'Physiology',
    Q48 == 13 ~ 'Other science',
    Q48 == 14 ~ 'Non-science',
    Q48 == 15 ~ 'Open/undeclared',
    TRUE ~ 'Unknown'
  ),
  Gender = case_when(
    Q54 == 1 ~ 'Woman',
    Q54 == 2 ~ 'Man',
    Q54 == 3 ~ 'Other',
    TRUE ~ 'Unknown'
  )) %>%
  mutate(Major = case_when(
    (Major == 'Physics') | (Major == 'Engineering Physics') | (Major == 'Astronomy') | 
      (Major == 'Astrophysics') ~ 'Physics',
    (Major == 'Chemistry') | (Major == 'Biochemistry') | (Major == 'Biology') | 
      (Major == 'Physiology') ~ 'Chem.LifeSci',
    Major == 'Engineering' ~ 'Engineering',
    (Major == 'Math/applied math') | (Major == 'Computer science') ~ 'Math.CS',
    (Major == 'Geology/geophysics') | (Major == 'Other science') ~ 'OtherSci',
    Major == 'Non-science' ~ 'NonSci',
    Major == 'Open/undeclared' ~ 'Undeclared',
    Major == 'Unknown' ~ 'Unknown',
    TRUE ~ NA_character_
  )) %>% # set reference levels for factors...important for regressions
  mutate(Major = relevel(as.factor(Major), ref = 'Physics'),
         Gender = relevel(as.factor(Gender), ref = 'Man'),
         Lab.type = relevel(as.factor(Lab.type), ref = 'Concepts-based'),
         Course.level = relevel(as.factor(Course.level), ref = 'FY'))

# rename race columns
new.race.cols <- c('Race.ethnicity.Other', 'Race.ethnicity.Black', 
                 'Race.ethnicity.Hispanic', 'Race.ethnicity.Asian', 
                 'Race.ethnicity.White', 'Race.ethnicity.Unknown',
                 'Race.ethnicity.AmInd', 'Race.ethnicity.NatHawaii')
setnames(df.matched, old = c('Q52_7', 'Q52_3', 'Q52_4', 'Q52_2', 'Q52_6', 
                             'race_unknown', 'Q52_5', 'Q52_1'), new = 
           new.race.cols)

# fill all NAs with zero and set factors to binary
df.matched[is.na(df.matched)] <- 0
df.matched[new.race.cols] <- lapply(df.matched[new.race.cols], factor, 
                                    levels = c(0, 1))
```

# Demographic breakdowns
```{r}
Race.ethnicity.cols <- names(df.matched)[names(df.matched) %like% 'Race']
Race.ethnicity.table <- function(df, Lab.type = FALSE){
  # race/ethnicity variables are not independent...this function calculates tables
  # for each of those variables
  if(Lab.type){
    for(col in Race.ethnicity.cols){
      print(col)
      print(table(df[, col], df$Lab.type))
    }
  } else {
    for(col in Race.ethnicity.cols){
      print(col)
      print(table(df[, col]))
    }
  }
}

# get demographic breakdowns across lab type
table(df.matched$Gender)
Race.ethnicity.table(df.matched)
table(df.matched$Lab.goal)
table(df.matched$Gender, df.matched$Lab.type)
Race.ethnicity.table(df.matched, Lab.type = TRUE)
```

# Descriptive statistics
```{r}
plot.pre.post <- function(df, var){
  # plot pre-post score shifts on overall student scores
  if(var == 'Race.ethnicity'){
    # race/ethnicity variables aren't independent, so we melt twice...first to put 
    # pre-post scores in long form
    df.long <- reshape2::melt(df.matched, id.vars = new.race.cols, 
                              measure.vars = c('student.score.pre',
                                               'student.score.post'),
                              variable.name = 'Time', value.name = 'Score') %>%
      # ...then again to put race/ethnicity in long form
      reshape2::melt(., measure.vars = new.race.cols, 
                     id.vars = c('Time', 'Score'), 
                     variable.name = 'Race.ethnicity') %>%
      filter(value == 1) %>%
      select(Time, Score, Race.ethnicity) %>%
      rowwise() %>% # rowwise split the characters in the column to get labels
      mutate(Race.ethnicity = strsplit(as.character(Race.ethnicity), 
                                       '\\.')[[1]][3])
    
  } else {
    # we only need to put the scores in long form since the gender/lab type
    # variables are already long
    df.long <- reshape2::melt(df, measure.vars = c('student.score.pre',
                                                   'student.score.post'), 
                              variable.name = 'Time', value.name = 'Score')
  }
  
  p <- ggplot(df.long, aes_string(x = var, y = 'Score', group = 'Time', 
                                  color = 'Time'))
  ggpubr::add_summary(p, fun = 'mean_se', group = c('Time')) +
    scale_color_manual(labels = c('pre', 'post'), values = c('#2271B2', 
                                                             '#D55E00')) +
    theme(axis.text.x = element_text(angle = 90))
}

plot.pre.post(df.matched, 'Gender')
plot.pre.post(df.matched, 'Race.ethnicity')
plot.pre.post(df.matched, 'Lab.type')
```

# Mixed-effects models
```{r}
# fit null model with random intercepts for class and institution 
# this model measures the interclass correlation coefficient (ICC)
mod0 <- lmer(student.score.post ~ (1 | anon_university_id/ResponseId.CIS), df.matched)
r2(mod0)

# fit model of interest
mod <- lmer(student.score.post ~ student.score.pre + Course.level + Lab.type * 
               (Gender + Race.ethnicity.AmInd + Race.ethnicity.NatHawaii + 
               Race.ethnicity.Other + Race.ethnicity.Black +
                 Race.ethnicity.Hispanic + Race.ethnicity.Asian + 
                 Race.ethnicity.White + Race.ethnicity.Unknown) + 
               Major + (1 | anon_university_id/ResponseId.CIS), df.matched)
summary(mod)
r2(mod)

class(mod) <- "lmerMod"
mod.std <- std_beta(mod, ci = 0.67)
mod.std$uncertainty <- abs(mod.std$Std_Coefficient - mod.std$CI_low)
```

# Variance inflation factors and model diagnostics
```{r}
# variance inflation factors...ratio of variance in measured parameter compared to 
# model with only that parameter
vif(mod)
# fitted values versus residuals...should be no trend
plot(mod, xlab = 'Fitted values', ylab = 'Residuals')
qqmath(mod) # standardized residuals versus standard quantiles
```

# Output stargazer
```{r, results = 'hide', message = FALSE, warning = FALSE, include = FALSE}
# standardized model appended .z to this column, so we remove the appendix
# coefficient labels
labels = c("Constant", "Pretest", "Beyond-first-year",
           "Mixed", "Skills-based", "Non-binary", "Unknown", "Woman", 
           "American Indian", "Native Hawaiian", "Other", "Black", "Hispanic", 
           "Asian", "White", "Unknown", "LifeSci/Chem", "Engineering", "Math/CS", 
           "Non-science", "Other science", "Undeclared", "Unknown", 
           "Mixed * Non-binary", "Skills-based * Non-binary", 
           "Mixed * Unknown", "Skills-based * Unknown", "Mixed * Woman", 
           "Skills-based * Woman", "Mixed * American Indian", 
           "Skills-based * American Indian", "Mixed * Native Hawaiian", 
           "Skills-based * Native Hawaiian", "Mixed * Other",  
           "Skills-based * Other", "Mixed * Black", "Skills-based * Black", 
           "Mixed * Hispanic", "Skills-based * Hispanic", "Mixed * Asian", 
           "Skills-based * Asian", "Mixed * White", "Skills-based * White", 
           "Mixed * Unknown", "Skills-based * Unknown")

# concatenate estimates and SEs from raw and standardized models
stargazer(mod, mod, mod, mod, coef = list(summary(mod)$coefficients[, 1],
                                          summary(mod)$coefficients[, 2], 
                                          mod.std$Std_Coefficient,
                                          mod.std$uncertainty), 
          se = list(summary(mod)$coefficients[, 2], NA, 
                    mod.std$uncertainty, NA), 
          type = 'latex', intercept.bottom = FALSE, style = 'asr', 
          column.labels = c('Beta', 'SE', 'Beta.std', 'SE'), model.numbers = FALSE,
          covariate.labels = labels, dep.var.labels = 'E-CLASS posttest scores',
          out ='E-CLASS_model.tex')
```

# Marginal effects plots
```{r}
# marginal effects (average effect) of different labs on posttest scores
p1 <- plot_model(mod, type = 'eff', terms = c('Lab.type'), ci.lvl = 0.67)

p1.new <- ggplot(data.frame(p1$data), aes(x = factor(x), y = predicted, 
                                          color = factor(x))) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), size = 1, width = 0,
                position = position_dodge(width = 0.5)) +
  scale_x_discrete(labels = c('Concepts-based', 'Mixed', 'Skills-based')) +
  scale_color_manual(values = c('#e69f00', '#009e74', '#0071b2')) +
  labs(x = 'Lab type', y = 'Predicted E-CLASS posttest scores') +
  theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust = 1),
        legend.position = 'none')

# average over lab type and gender
p2 <- plot_model(mod, type = 'eff', terms = c('Gender', 'Lab.type'), dot.size = 2, 
                 line.size = 1, ci.lvl = 0.67, title = '', 
                 axis.title = '', 
                 colors = c('#e69f00', '#009e74', '#0071b2'), dodge = 0.5) +
  scale_x_discrete(limits = c("Man", "Non-binary", "Woman", "Unknown")) +
  labs(x = 'Gender', y = '') +
  theme(legend.position = 'top')

p2.new <- p2
p2.new$data$x <- rep(c(1, 2, 4, 3), 3)

get_legend <- function(myggplot){
  # from http://www.sthda.com/english/wiki/wiki.php?id_contents=7930
  tmp <- ggplot_gtable(ggplot_build(myggplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}

leg <- get_legend(p2.new)
p2.new <- p2.new + theme(legend.position = 'none',
                         axis.text.x = element_text(angle = 40, vjust = 1, 
                                                    hjust = 1),
                         plot.margin = unit(c(0, 0, 0, -0.5), 'cm'))
```

# Race/ethnicity marginal effects plots
```{r}
# average over lab type and race/ethnicity...since race/ethnicity variables are not 
# independent, we calculate marginal effects separately for each variable...
p3.native <- plot_model(mod, type = 'eff', terms = c('Race.ethnicity.Other [1]', 
                                                      'Lab.type'), ci.lvl = 0.67) 
# the [1]s are because effects are estimated for variable = 0 and variable = 1...we only 
# want the 1s
df.race.eff <- data.frame(p3.native$data) %>%
  mutate(race.ethnicity = 'Race.ethnicity.Other')
for(race in c(new.race.cols[2:length(new.race.cols)])){
  p3 <- plot_model(mod, type = 'eff', terms = c(paste(race, ' [1]', sep = ''),
                                                 'Lab.type'), ci.lvl = 0.67)
  # ...bind results in one dataframe...
  df.race.eff <- rbind(df.race.eff, data.frame(p3$data) %>%
                         mutate(race.ethnicity = race))
}

# ...and clean up the dataframe a little bit
df.race.eff <- df.race.eff %>%
  rowwise() %>%
  mutate(race.ethnicity = strsplit(race.ethnicity, '\\.')[[1]][3]) %>%
  mutate(group = factor(group, levels = c('Concepts-based', 'Mixed', 
                                          'Skills-based'),
                        ordered = TRUE),
         race.ethnicity = case_when(
           race.ethnicity == 'AmInd' ~ 'American Indian',
           race.ethnicity == 'NatHawaii' ~ 'Native Hawaiian',
           TRUE ~ race.ethnicity))

p3 <- ggplot(df.race.eff, aes(x = factor(race.ethnicity, 
                                         levels = c('American Indian', 'Asian', 
                                                    'Black', 'Hispanic', 
                                                    'Native Hawaiian', 'White', 
                                                    'Other', 'Unknown')), 
                        y = predicted, group = group, color = group)) +
  geom_point(size = 2, position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), size = 1, width = 0.2,
                position = position_dodge(width = 0.5)) +
  scale_color_manual(values = c('#e69f00', '#009e74', '#0071b2')) +
  labs(x = 'Race/ethnicity', y = '') +
  theme(axis.text.x = element_text(angle = 40, vjust = 1, hjust = 1),
        legend.position = 'none',
        plot.margin = unit(c(0, 0, 0, -0.5), 'cm'))
```

```{r}
png('Figures/E-CLASS_Labtype_Demos.png', width = 586, height = 363)
grobs = cbind(ggplotGrob(p1.new), ggplotGrob(p2.new), ggplotGrob(p3), size = "first")
grid.arrange(leg, arrangeGrob(grobs), heights = c(1, 10))
dev.off()
```

# Process CIS items
```{r}
df.matched[, names(df.matched) %like% "Q34|Q35|Q36|Q37|Q38"] <- 
  data.frame(lapply(df.matched[, names(df.matched) %like% "Q34|Q35|Q36|Q37|Q38"], function(x) 
    droplevels(factor(as.vector(x), levels = c('Never', 'Rarely', 'Sometimes', 
                                               'Often', 'Always'), 
                      ordered = TRUE))))

df.matched[, names(df.matched) %like% "Q34|Q35|Q36|Q37|Q38"] <- data.frame(lapply(df.matched[, names(df.matched) %like% "Q34|Q35|Q36|Q37|Q38"],                                                           function(x) as.numeric(x)))
```

# Load PLIC dataset, combine and extract CIS items
```{r}
source('C:/Users/Cole/Documents/GitHub/PLIC/Processing-Scripts/PLIC_DataProcessing.R')

full.df <- read.csv('C:/Users/Cole/Documents/DATA/PLIC_DATA/Collective_Surveys/Complete/Complete_Concat_CourseInfo.csv') %>%
  filter(Survey_x == 'C' | Survey_y == 'C') %>%
  mutate(V4_x = as.Date(V4_x),
         V4_y = as.Date(V4_y)) %>%
  filter(V4_y < as.Date('2020-01-01') | (is.na(V4_y) & 
                                           V4_x < as.Date('2020-01-01')))

# Remove FR scores
full.df[full.df$Survey_x == 'F', 'PreScores'] <- NA_real_
full.df[full.df$Survey_y == 'F', 'PostScores'] <- NA_real_

# Remove whole classes without goal and/or level information or that were only administered at pre or post
full.df <- data.table(full.df)[, `:=`(N.students = .N, 
                                      pre.rate = sum(Survey_x == 'C')/.N,
                                      post.rate = sum(Survey_y == 'C')/.N),  
                               .(Class_ID)]

full.df <- full.df %>%
  filter(!is.na(Lab_level) & !is.na(Lab_purpose) & (Lab_purpose != '') & 
           (pre.rate > 0) & (post.rate > 0))

df.PLIC.matched <- full.df %>%
  filter(!is.na(PreScores) & !is.na(PostScores))

# Creates new gender/race/major columns
df.PLIC.matched <- Collapse.vars(data.frame(df.PLIC.matched)) %>%
  mutate(Lab_level = relevel(as.factor(case_when(
    (Lab_level == 'Intro-Algebra') | (Lab_level == 'Intro-Calculus') ~ 'FY',
    (Lab_level == 'Sophomore') | (Lab_level == 'Junior') | 
      (Lab_level == 'Senior') | (Lab_level == 'Graduate') ~ 'BFY',
    TRUE ~ NA_character_
  )), ref = 'FY'),
  Lab_purpose = relevel(as.factor(case_when(
    Lab_purpose == 'Reinforce concepts' ~ 'Concepts-based',
    Lab_purpose == 'Both about equally' ~ 'Mixed',
    Lab_purpose == 'Develop lab skills' ~ 'Skills-based')), 
    ref = 'Concepts-based'))

df.PLIC.matched[, names(df.PLIC.matched) %like% "Q28|Q29|Q31|Q32|Q33"] <- 
  data.frame(lapply(df.PLIC.matched[, 
                                    names(df.PLIC.matched) %like% 
                                      "Q28|Q29|Q31|Q32|Q33"], 
                    function(x) droplevels(factor(as.vector(x), 
                                                  levels = c('1', '2', '3', '4',
                                                             '5'), 
                                                  ordered = TRUE))))

df.PLIC.matched[, names(df.PLIC.matched) %like% "Q28|Q29|Q31|Q32|Q33"] <- data.frame(lapply(df.PLIC.matched[, 
                                                                                                            names(df.PLIC.matched) %like% "Q28|Q29|Q31|Q32|Q33"],                                                           function(x) as.numeric(x)))

df.ECLASS.matched <- df.matched[, c(names(df.matched)[names(df.matched) %like% 
                                                        "Q34|Q35|Q36|Q37|Q38"], 
                                    'Lab.type', 'Course.level',
                                    'student.score.pre', 'student.score.post',
                                    'ResponseId.CIS')] %>%
  mutate(Assessment = 'ECLASS')

df.PLIC.matched <- df.PLIC.matched[,
                                   c(names(df.PLIC.matched)[names(df.PLIC.matched) 
                                                            %like% "Q28|Q29|Q31|Q32|Q33"], 
                                     'Lab_purpose', 'Lab_level', 'PreScores', 
                                     'PostScores', 'Class_ID')] %>%
  mutate(Assessment = 'PLIC')

colnames(df.PLIC.matched) <- colnames(df.ECLASS.matched)
df.ECLASS <- df.ECLASS.matched[!duplicated(df.ECLASS.matched$ResponseId.CIS),]
df.PLIC <- df.PLIC.matched[!duplicated(df.PLIC.matched$ResponseId.CIS),]

df.CIS <- rbind(df.ECLASS, df.PLIC)[, 
                                    names(df.ECLASS)[names(df.ECLASS) %like% 
                                                     "Q34|Q35|Q36|Q37|Q38"]] %>%
  unique(.)

df.CIS
```

# CFA

## Number 1
```{r}
mod.cfa <- '
  agency =~ Q35_1 + Q35_2 + Q35_3 + Q35_4 + Q35_5 + Q35_6 + Q34_1 + Q34_2 + Q34_3
  modeling =~ Q36_1 + Q36_2 + Q36_3 + Q36_4 + Q36_5 + Q36_6 + Q36_7
  analysis =~ Q37_1 + Q37_2 + Q37_3 + Q37_4
  communication =~ Q38_1 + Q38_2 + Q38_3 + Q38_4
'

fit <- sem(mod.cfa, data = df.CIS)
summary(fit, standardized = TRUE, fit.measures = TRUE, modindices = TRUE)
standardizedsolution(fit)
colSums(1 * (abs(resid(fit, type = 'cor')$cov) > 0.2))
resid(fit, type = 'cor')$cov
```

## Number 2
```{r}
mod.cfa <- '
  agency =~ Q35_1 + Q35_2 + Q35_3 + Q35_4 + Q35_5 + Q34_1 + Q34_3 + Q36_6
  modeling =~ Q36_1 + Q36_2 + Q36_3 + Q36_4
  communication =~ Q38_1 + Q38_2 + Q38_3 + Q38_4
'

fit <- sem(mod.cfa, data = df.CIS)
summary(fit, standardized = TRUE, fit.measures = TRUE, modindices = TRUE)
standardizedsolution(fit)
colSums(1 * (abs(resid(fit, type = 'cor')$cov) > 0.15))
resid(fit, type = 'cor')$cov
```

## Number 3
```{r}
mod.cfa <- '
  agency =~ Q35_1 + Q35_2 + Q35_3 + Q35_4 + Q35_5 + Q34_3 + Q36_6
  modeling =~ Q36_1 + Q36_2 + Q36_3 + Q36_4
  communication =~ Q38_1 + Q38_2 + Q38_3 + Q38_4
  Q36_1 ~~ Q36_2 + Q36_3
  Q36_4 ~~ Q36_2 + Q36_3
'

fit <- sem(mod.cfa, data = df.CIS)
summary(fit, standardized = TRUE, fit.measures = TRUE, modindices = TRUE)
standardizedsolution(fit)
colSums(1 * (abs(resid(fit, type = 'cor')$cov) > 0.2))
resid(fit, type = 'cor')$cov
```

# Full SEM
```{r}
df.matched <- df.matched %>%
  mutate(Lab.goal.skills = 1 * (Lab.type == 'Skills-based'),
         Lab.goal.both = 1 * (Lab.type == 'Mixed'),
         Lab.goal.concepts = 1 * (Lab.type == 'Concepts-based'))

df.FY <- df.matched %>%
  filter(Course.level == 'FY')
df.BFY <- df.matched %>%
  filter(Course.level == 'BFY')

mod.sem <- '
  level: 1
    student.score.post ~ student.score.pre
  level: 2
    agency =~ Q35_1 + Q35_2 + Q35_3 + Q35_4 + Q35_5 + Q34_3 + Q36_6
    modeling =~ Q36_1 + Q36_2 + Q36_3 + Q36_4
    communication =~ Q38_1 + Q38_2 + Q38_3 + Q38_4
    #Q36_1 ~~ Q36_2 + Q36_3
    #Q36_4 ~~ Q36_3 + Q36_2

    agency ~ Lab.goal.skills + Lab.goal.both
    communication ~ Lab.goal.skills + Lab.goal.both
    modeling ~ Lab.goal.skills + Lab.goal.both

    agency ~~ communication + modeling
    communication ~~ modeling

    student.score.post ~ agency + communication + modeling + Lab.goal.skills + Lab.goal.both
'

fit <- sem(mod.sem, data = df.FY, cluster = "ResponseId.CIS")
summary(fit, standardized = TRUE, fit.measures = TRUE, modindices = TRUE)
standardizedsolution(fit)
resid(fit, type = 'cor')
```

# Partial SEMs
```{r}
mod.agency <- '
  level: 1
    student.score.post ~ student.score.pre
  level: 2
    agency =~ Q35_1 + Q35_2 + Q35_3 + Q35_4 + Q35_5 + Q34_3 + Q36_6

    agency ~ Lab.goal.skills + Lab.goal.both

    student.score.post ~ agency + Lab.goal.skills + Lab.goal.both
'

mod.modeling <- '
  level: 1
    student.score.post ~ student.score.pre
  level: 2
    modeling =~ Q36_1 + Q36_2 + Q36_3 + Q36_4
    #Q36_1 ~~ Q36_3 #+ Q36_2
    #Q36_4 ~~ Q36_3 #+ Q36_2

    modeling ~ Lab.goal.skills + Lab.goal.both

    student.score.post ~ modeling + Lab.goal.skills + Lab.goal.both
'

mod.communication <- '
  level: 1
    student.score.post ~ student.score.pre
  level: 2
    communication =~ Q38_1 + Q38_2 + Q38_3 + Q38_4

    communication ~ Lab.goal.skills + Lab.goal.both

    student.score.post ~ communication + Lab.goal.skills + Lab.goal.both
'

fit <- sem(mod.agency, data = df.FY, cluster = "ResponseId.CIS")
summary(fit, standardized = TRUE, fit.measures = TRUE, modindices = TRUE)
standardizedsolution(fit)
resid(fit, type = 'cor')

fit <- sem(mod.modeling, data = df.FY, cluster = "ResponseId.CIS")
summary(fit, standardized = TRUE, fit.measures = TRUE, modindices = TRUE)
standardizedsolution(fit)
resid(fit, type = 'cor')

fit <- sem(mod.communication, data = df.FY, cluster = "ResponseId.CIS")
summary(fit, standardized = TRUE, fit.measures = TRUE, modindices = TRUE)
standardizedsolution(fit)
resid(fit, type = 'cor')
```

# Partial SEMs with BFY dataset
```{r}
fit <- sem(mod.agency, data = df.BFY, cluster = "ResponseId.CIS")
summary(fit, standardized = TRUE, fit.measures = TRUE, modindices = TRUE)
standardizedsolution(fit)
resid(fit, type = 'cor')

fit <- sem(mod.modeling, data = df.BFY, cluster = "ResponseId.CIS")
summary(fit, standardized = TRUE, fit.measures = TRUE, modindices = TRUE)
standardizedsolution(fit)
resid(fit, type = 'cor')

fit <- sem(mod.communication, data = df.BFY, cluster = "ResponseId.CIS")
summary(fit, standardized = TRUE, fit.measures = TRUE, modindices = TRUE)
standardizedsolution(fit)
resid(fit, type = 'cor')
```


```{r}
df.comb <- na.omit(rbind(df.ECLASS.matched, df.PLIC.matched))
fit <- sem(mod.cfa, data = df.CIS)
sem.df <- lavPredict(fit, df.comb, method = 'regression')
sem.df <- cbind(df.comb, sem.df)

sem.df <- sem.df %>%
  mutate(Lab.goal.skills = 1 * (Lab.type == 'Skills-based'),
         Lab.goal.both = 1 * (Lab.type == 'Mixed'),
         Lab.goal.concepts = 1 * (Lab.type == 'Concepts-based'))

mod.sem <- '
  #level: 1
    # student.score.post ~ student.score.pre
  #level: 2
    agency ~ Lab.goal.skills + Lab.goal.both
    modeling ~ Lab.goal.skills + Lab.goal.both
    communication ~ Lab.goal.skills + Lab.goal.both

    agency ~~ modeling + communication
    modeling ~~ communication

    student.score.post ~ student.score.pre + agency + modeling + communication + Lab.goal.skills + Lab.goal.both
'

fit <- sem(mod.sem, data = sem.df %>%
               filter((Course.level == 'FY') & (Assessment == 'ECLASS')))
summary(fit, standardized = TRUE, fit.measures = TRUE, modindices = TRUE)
standardizedsolution(fit)
resid(fit, type = 'cor')

fit <- sem(mod.sem, data = sem.df %>%
               filter((Course.level == 'BFY') & (Assessment == 'ECLASS')))
summary(fit, standardized = TRUE, fit.measures = TRUE, modindices = TRUE)
standardizedsolution(fit)
resid(fit, type = 'cor')

fit <- sem(mod.sem, data = sem.df %>%
               filter((Course.level == 'FY') & (Assessment == 'PLIC')))
summary(fit, standardized = TRUE, fit.measures = TRUE, modindices = TRUE)
standardizedsolution(fit)
resid(fit, type = 'cor')

# fit <- sem(mod.sem, data = sem.df %>%
#                filter((Course.level == 'BFY') & (Assessment == 'PLIC')))
# summary(fit, standardized = TRUE, fit.measures = TRUE, modindices = TRUE)
# standardizedsolution(fit)
# resid(fit, type = 'cor')
```

