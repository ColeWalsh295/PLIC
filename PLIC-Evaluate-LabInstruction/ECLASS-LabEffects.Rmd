---
output:
  pdf_document: default
  html_document: default
---
# Load necessary packages
```{r, results = 'hide', message = FALSE, warning = FALSE}
library(tidyverse)
library(data.table)
library(reshape2)
library(ggpubr)
library(lmerTest)
library(reghelper)
library(car)
library(lattice)
library(sjstats)
library(sjPlot)
library(gridExtra)
library(stargazer)
library(lavaan)
library(semPlot)
library(psych)
theme_set(theme_classic(base_size = 14))
```

# Scoring/cleaning functions
```{r}
Read.Score <- function(file){
  dt <- fread(file)
  answers.cols <- names(dt)[grep('(a|b)$', names(dt))]
  
  dt[, (answers.cols) := lapply(.SD, function(x) case_when(x == 5 ~ 1,
                                                           x == 1 ~ -1,
                                                           TRUE ~ 0)),
     .SDcols = answers.cols]
  df <- dt[, -c('q40a', 'q40b')]

  df$student.score <- rowSums(df %>% select(grep("a$", names(.))))
  df$expert.score <- rowSums(df %>% select(grep("b$", names(.))))
  
  return(df)
}

Read.duplicate.cis <- function(file){
  cis.df <- read.csv(file)
  
  cis.noInfo <- cis.df[(cis.df$Q33 == '') | is.na(cis.df$Q33),]
  cis.FullInfo <- cis.df[(cis.df$Q33 != '') & !is.na(cis.df$Q33),]
  
  original.cols <- c('Q5', 'Q52',	'Q53', 'Q27', 'Q6',	'Q11', 'Q19',	'Q20', 'StartDate',
                     'anon_instructor_id', 'ResponseId.CIS', 'pre_survey_id', 'post_survey_id')

  cis.noInfo <- left_join(cis.noInfo, cis.FullInfo, 
                          by = c('anon_university_id', 'Q18'), 
                          suffix = c('.original', '.copy')) %>%
    select(anon_university_id, Q18, Q15.copy,	Q21.copy,	Q22_1.copy,	Q22_2.copy,	Q23.copy, 
           Q29.copy, grep('Q(3|4)\\d_?\\d?\\.copy', names(.)), 
           paste(original.cols, '.original', sep = '')) %>%
    filter(!duplicated(ResponseId.original) & !is.na(ResponseId.original)) %>%
    `colnames<-`(unlist(lapply(names(.), function (x) strsplit(x, '\\.')[[1]][1])))
  
  cis.df <- rbind(cis.FullInfo, cis.noInfo[, names(cis.df)])
  return(cis.df)
}
```

# Read, score, and match
```{r}
#cis.df <- Read.duplicate.cis('C:/Users/Cole/Documents/GRA_Summer2020/eclass-public-analysis/anon_cis.csv')

cis.df <- read.csv('C:/Users/Cole/Documents/GRA_Summer2020/eclass-public-analysis/anon_cis_CW.csv')

pre.df <- Read.Score('C:/Users/Cole/Documents/GRA_Summer2020/eclass-public-analysis/anon_pre.csv')

cis.pre.df <- right_join(cis.df, pre.df, by = c('pre_survey_id' = 'survey_id'), 
                         suffix = c('.CIS', '.pre'))

post.df <- Read.Score('C:/Users/Cole/Documents/GRA_Summer2020/eclass-public-analysis/anon_post.csv')

full.df <- full_join(cis.pre.df, post.df, by = c('post_survey_id' = 'survey_id', 
                                                 'anon_student_id'), 
                     suffix = c('.pre', '.post')) #%>%
  #distinct(ResponseId.CIS, anon_student_id, .keep_all = TRUE)

#full.df <- left_join(full.df, cis.df, by = c('survey_id.pre' = 'pre_survey_id',
 #                                            'survey_id.post' = 'post_survey_id'))

full.df <- full.df %>%
    mutate(Lab.goal = case_when(
      Q33 == 'Reinforce physics concepts.' ~ 'Concepts',
      Q33 == 'Both about equally.' ~ 'Both',
      Q33 == 'Develop lab skills.' ~ 'Skills',
      TRUE ~ NA_character_
    ), 
    Lab.level = case_when(
      Q18 == 'Beyond the first year lab' ~ 'BFY',
      Q27 == 'Calculus-based' ~ 'FY.Calc',
      Q27 == 'Algebra-based' ~ 'FY.Alg',
      TRUE ~ NA_character_
    ))

print('Total # of students in dataset...')
nrow(full.df)

print('Total # of classes in dataset...')
length(unique(full.df$ResponseId.CIS))

print('Total # of institutions in dataset..')
length(unique(full.df$anon_university_id))

# Remove whole classes without goal and/or level information
full.df <- data.table(full.df)[, `:=`(N.students = .N, 
                                      pre.rate = sum(!is.na(student.score.pre))/.N,
                                      post.rate = sum(!is.na(student.score.post))/.N), 
                               .(ResponseId.CIS)]

full.df <- full.df %>%
  filter(!is.na(Lab.goal) & !is.na(Lab.level) & (pre.rate > 0) & (post.rate > 0))

print('# of remaining students in full dataset...')
nrow(full.df)

print('# of remaining classes in full dataset...')
length(unique(full.df$ResponseId.CIS))

print('Total # of institutions in dataset..')
length(unique(full.df$anon_university_id))

df.matched <- full.df %>%
  filter(!is.na(student.score.pre) & !is.na(student.score.post))

print('# of students in matched dataset...')
nrow(df.matched)

print('# of classes in matched dataset...')
length(unique(df.matched$ResponseId.CIS))

print('Total # of institutions in dataset..')
length(unique(df.matched$anon_university_id))

table(df.matched[!duplicated(df.matched$anon_university_id),]$Q15, exclude = NULL)
table(df.matched[!duplicated(df.matched$ResponseId.CIS),]$Lab.level, exclude = NULL)
table(df.matched[!duplicated(df.matched$ResponseId.CIS),]$Lab.goal, exclude = NULL)
```

```{r}
full.df[duplicated(full.df[, c('ResponseId.CIS', 'anon_student_id')]),]

nrow(full.df[!is.na(full.df$student.score.post),])
nrow(post.df %>%
       distinct(anon_student_id, survey_id))
```


# Data processing
```{r}
# Replace declared major with intended major in cases where students intend to switch
df.matched[is.na(df.matched$Q48) | (df.matched$Q48 == 0),
'Q48'] <- df.matched[is.na(df.matched$Q48) | (df.matched$Q48 == 0), 'Q47']

df.matched <- df.matched %>%
  mutate(Major = case_when(
    Q48 == 1 ~ 'Physics',
    Q48 == 2 ~ 'Chemistry',
    Q48 == 3 ~ 'Biochemistry',
    Q48 == 4 ~ 'Biology',
    Q48 == 5 ~ 'Engineering',
    Q48 == 6 ~ 'Engineering Physics',
    Q48 == 7 ~ 'Astronomy',
    Q48 == 8 ~ 'Astrophysics',
    Q48 == 9 ~ 'Geology/geophysics',
    Q48 == 10 ~ 'Math/applied math',
    Q48 == 11 ~ 'Computer science',
    Q48 == 12 ~ 'Physiology',
    Q48 == 13 ~ 'Other science',
    Q48 == 14 ~ 'Non-science',
    Q48 == 15 ~ 'Open/undeclared',
    TRUE ~ 'Unknown'
  ),
  Gender = case_when(
    Q54 == 1 ~ 'Woman',
    Q54 == 2 ~ 'Man',
    Q54 == 3 ~ 'Other',
    TRUE ~ 'Unknown'
  )) %>%
  mutate(Major = case_when(
    (Major == 'Physics') | (Major == 'Engineering Physics') | (Major == 'Astronomy') | 
      (Major == 'Astrophysics') ~ 'Physics',
    (Major == 'Chemistry') | (Major == 'Biochemistry') | (Major == 'Biology') | 
      (Major == 'Physiology') ~ 'Chem.LifeSci',
    Major == 'Engineering' ~ 'Engineering',
    (Major == 'Math/applied math') | (Major == 'Computer science') ~ 'Math.CS',
    (Major == 'Geology/geophysics') | (Major == 'Other science') ~ 'OtherSci',
    Major == 'Non-science' ~ 'NonSci',
    Major == 'Open/undeclared' ~ 'Undeclared',
    Major == 'Unknown' ~ 'Unknown',
    TRUE ~ NA_character_
  )) %>%
  mutate(Major = relevel(as.factor(Major), ref = 'Physics'),
         Gender = relevel(as.factor(Gender), ref = 'Man'),
         Lab.goal = relevel(as.factor(Lab.goal), ref = 'Concepts'),
         Lab.level = relevel(as.factor(Lab.level), ref = 'FY.Alg'))

df.matched$Race.ethnicity.Native = relevel(factor(ifelse((df.matched$Q52_5 == 1) | 
                                                      (df.matched$Q52_1 == 1), 1, 0),
                                                  levels = c(1, 0)), ref = '0')
new.race.cols <- c('Race.ethnicity.Other', 'Race.ethnicity.Black', 
                 'Race.ethnicity.Hispanic', 'Race.ethnicity.Asian', 
                 'Race.ethnicity.White', 'Race.ethnicity.Unknown')
setnames(df.matched, old = c('Q52_7', 'Q52_3', 'Q52_4', 'Q52_2', 'Q52_6', 
                             'race_unknown'), new = new.race.cols)
df.matched[is.na(df.matched)] <- 0
df.matched[new.race.cols] <- lapply(df.matched[new.race.cols], factor, levels = c(1, 0))
df.matched[new.race.cols] <- lapply(df.matched[new.race.cols], relevel, ref = '0')
```

# Demographic breakdowns
```{r}
Race.ethnicity.cols <- names(df.matched)[names(df.matched) %like% 'Race']
Race.ethnicity.table <- function(df, Lab.Purpose = FALSE){
  if(Lab.Purpose){
    for(col in Race.ethnicity.cols){
      print(col)
      print(table(df[, col], df$Lab.goal))
    }
  } else {
    for(col in Race.ethnicity.cols){
      print(col)
      print(table(df[, col]))
    }
  }
}

table(df.matched$Gender)
Race.ethnicity.table(df.matched)
table(df.matched$Major)
table(df.matched$Lab.goal)
table(df.matched$Gender, df.matched$Lab.goal)
Race.ethnicity.table(df.matched, Lab.Purpose = TRUE)
table(df.matched$Major, df.matched$Lab.goal)

chisq.test(df.matched[!duplicated(df.matched$ResponseId.CIS), 'Lab.goal'], 
           df.matched[!duplicated(df.matched$ResponseId.CIS), 'Lab.level'])
summary(aov(student.score.pre ~ Lab.goal, df.matched))
```

# Descriptive statistics
```{r}
plot.pre.post <- function(df, var){
  if(var == 'Race.ethnicity'){
    print(colSums(sapply(df[, c('Race.ethnicity.Native', new.race.cols)], 
                         function (x) as.numeric(as.character(x)))))
    
    df.long <- reshape2::melt(df.matched, id.vars = c('Race.ethnicity.Native', 
                                                      new.race.cols), 
                              measure.vars = c('student.score.pre', 'student.score.post'),
                              variable.name = 'Time', value.name = 'Score') %>%
      reshape2::melt(., measure.vars = c('Race.ethnicity.Native', new.race.cols), 
                     id.vars = c('Time', 'Score'), variable.name = 'Race.ethnicity') %>%
      filter(value == 1) %>%
      select(Time, Score, Race.ethnicity) %>%
      rowwise() %>%
      mutate(Race.ethnicity = strsplit(as.character(Race.ethnicity), '\\.')[[1]][3])
    
  } else {
    print(table(df[, var]))
    df.long <- reshape2::melt(df, measure.vars = c('student.score.pre',
                                                   'student.score.post'), 
                              variable.name = 'Time', value.name = 'Score')
  }
  
  p <- ggplot(df.long, aes_string(x = var, y = 'Score', group = 'Time', color = 'Time'))
  add_summary(p, fun = 'mean_se', group = c('Time')) +
    scale_color_manual(labels = c('pre', 'post'), values = c('#2271B2', '#D55E00')) +
    theme(axis.text.x = element_text(angle = 90))
}

plot.pre.post(df.matched, 'Major')
plot.pre.post(df.matched, 'Gender')
plot.pre.post(df.matched, 'Race.ethnicity')
plot.pre.post(df.matched, 'Lab.goal')
```

# Mixed-effects models
```{r}
mod0 <- lmer(student.score.post ~ (1 | ResponseId.CIS), df.matched)
r2(mod0)

mod1 <- lmer(student.score.post ~ student.score.pre + Lab.goal + Lab.level + Major + 
               Gender + Race.ethnicity.Native + Race.ethnicity.Other +
               Race.ethnicity.Black + Race.ethnicity.Hispanic + Race.ethnicity.Asian + 
               Race.ethnicity.White + Race.ethnicity.Unknown + (1 | ResponseId.CIS), 
             df.matched)
# summary(mod1)

mod2 <- lmer(student.score.post ~ student.score.pre + Lab.level + Lab.goal * 
               (Gender + Race.ethnicity.Native + Race.ethnicity.Other + 
                  Race.ethnicity.Black + Race.ethnicity.Hispanic + Race.ethnicity.Asian + 
                  Race.ethnicity.White + Race.ethnicity.Unknown) + Major + 
               (1 | ResponseId.CIS), df.matched)
# summary(mod2)

r2(mod1)
r2(mod2)

noStandard.cols <- c('Lab.goal', 'Lab.level', 'Major', 'Gender', 
                     names(df.matched)[names(df.matched) %like% "Race"])
class(mod1) <- "lmerMod"
class(mod2) <- "lmerMod"
mod1.std <- beta(mod1, skip = noStandard.cols)
mod2.std <- beta(mod2, skip = noStandard.cols)
```

# Variance inflation factors and model diagnostics
```{r}
vif(mod1)
vif(mod2)

plot(mod1, xlab = 'Fitted values', ylab = 'Residuals')
qqmath(mod1)

plot(mod2, xlab = 'Fitted values', ylab = 'Residuals')
qqmath(mod2)
```


# Output stargazer
```{r, results = 'hide', message = FALSE, warning = FALSE}
rownames(mod1.std$coefficients)[2] <- 'student.score.pre'
rownames(mod2.std$coefficients)[2] <- 'student.score.pre'

labels = c("Constant", "Pretest", "Both", "Skills", "BFY", "FY-Calc", "LifeSci/Chem", 
           "Engineering", "Math/CS", "Non-Sci", "Other Sci", "Undeclared", "Unknown Maj", 
           "Both * Non-binary", "Skills * Non-binary", "Both * Unknown Gen",
           "Skills * Unknown Gen", "Both * Woman", "Skills * Woman", "Both * Native", 
           "Skills * Native", "Both * Other Race", "Skills * Other Race", "Both * Black", 
           "Skills * Black", "Both * Hispanic", "Skills * Hispanic", "Both * Asian", 
           "Skills * Asian", "Both * White", "Skills * White", "Both * Unknown Race", 
           "Skills * Unknown Race", "Non-binary", "Unknown Gen", "Woman", "Native", 
           "Other Race", "Black", "Hispanic", "Asian", "White", "Unknown Race")

stargazer(mod1, mod1, mod1, mod1, mod2, mod2, mod2, mod2, 
          coef = list(summary(mod1)$coefficients[, 1], summary(mod1)$coefficients[, 2], 
                      mod1.std$coefficients[, 1], mod1.std$coefficients[, 2], 
                      summary(mod2)$coefficients[, 1], summary(mod2)$coefficients[, 2],
                      mod2.std$coefficients[, 1], mod2.std$coefficients[, 2]), 
          se = list(summary(mod1)$coefficients[, 2], NA, mod1.std$coefficients[, 2], NA, 
                    summary(mod2)$coefficients[, 2], NA, mod2.std$coefficients[, 2], NA), 
          type='latex', intercept.bottom = FALSE, style = 'asr', keep.stat = c('n'), 
          column.labels = c('Beta', 'SE', 'Beta.std', 'SE', 'Beta', 'SE', 'Beta.std', 
                             'SE'), model.numbers = FALSE, covariate.labels = labels, 
          dep.var.labels = 'E-CLASS posttest scores', out ='E-CLASS_models.tex')
```


# Marginal effects plots
```{r}
# Main effect of lab goal from Model 1
p1 <- plot_model(mod1, type = 'eff', terms = 'Lab.goal', dot.size = 4, line.size = 1, 
                 ci.lvl = 0.67, title = '', 
                 axis.title = 'Predicted E-CLASS posttest scores', 
                 colors = c('#e69f00', '#009e74', '#0071b2'), dodge = 0.5) +
  theme(legend.position = 'right') +
  scale_x_discrete(limits = c("Reinforce concepts", "Both about equally", 
                              "Develop skills")) +
  xlab('Main purpose of lab')

p1.new <- p1
p1.new$data$x <- c(1, 2, 3)
p1.new

# Effects of gender across lab goal from Model 2

p2 <- plot_model(mod2, type = 'eff', terms = c('Gender', 'Lab.goal'), dot.size = 4, 
                 line.size = 1, ci.lvl = 0.67, title = '', 
                 axis.title = 'Predicted E-CLASS posttest scores', 
                 colors = c('#e69f00', '#009e74', '#0071b2'), dodge = 0.5) +
  scale_x_discrete(limits = c("Man", "Non-binary", "Woman", "Unknown")) +
  labs(color = 'Lab purpose')

p2.new <- p2
p2.new$data$group <- factor(p2.new$data$group, levels = c("Concepts", "Both", "Skills"))
p2.new$data$x <- rep(c(1, 2, 4, 3), 3)
p2.new
```

# Race/ethnicity marginal effects plots
```{r}
p3.native <- plot_model(mod2, type = 'eff', terms = c('Race.ethnicity.Native [1]', 
                                                      'Lab.goal'))
df.race.eff <- data.frame(p3.native$data) %>%
  mutate(race.ethnicity = 'Race.ethnicity.Native')
for(race in c(new.race.cols)){
  p3 <- plot_model(mod2, type = 'eff', terms = c(paste(race, ' [1]', sep = ''),
                                                 'Lab.goal'))
  df.race.eff <- rbind(df.race.eff, data.frame(p3$data) %>%
                         mutate(race.ethnicity = race))
}

df.race.eff <- df.race.eff %>%
  mutate(group = factor(group, levels = c('Concepts', 'Both', 'Skills'), 
                        ordered = TRUE)) %>%
  rowwise() %>%
  mutate(race.ethnicity = strsplit(race.ethnicity, '\\.')[[1]][3])

ggplot(df.race.eff, aes(x = factor(race.ethnicity, 
                                   levels = c('Asian', 'Black',  'Hispanic', 'Native', 
                                              'White', 'Other', 'Unknown')), 
                        y = predicted, group = group, color = group)) +
  geom_point(size = 4, position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), size = 1, width = 0.2,
                position = position_dodge(width = 0.5)) +
  scale_color_manual(values = c('#e69f00', '#009e74', '#0071b2')) +
  labs(x = 'Race/ethnicity', y = 'Predicted E-CLASS posttest scores', color = 'Lab purpose')
```

# Build measurement model for latent class variables
```{r}
df.matched[, names(df.matched) %like% "Q35|Q36"] <- data.frame(lapply(df.matched[, names(df.matched) %like% "Q35|Q36"], function(x) factor(as.vector(x), levels = c('Never', 'Rarely', 'Sometimes', 'Often', 'Always'), ordered = TRUE)))

mod <- '
  agency =~ Q35_1 + Q35_2 + Q35_3 + Q35_4 + Q35_5 + Q36_6
  modeling =~ Q36_1 + Q36_2 + Q36_3 + Q36_4 + Q36_5

  Q36_1 ~~ Q36_2
  Q36_1 ~~ Q36_3
  Q36_2 ~~ Q36_4
  Q36_3 ~~ Q36_4
'

fit <- sem(mod, unique(df.matched[, names(df.matched) %like% "Q35|Q36"]))
summary(fit, standardized = TRUE, fit.measures = TRUE, modindices = TRUE)
semPaths(fit, whatLabels = 'std', edge.color = 'black', curve = 2, residuals = FALSE, 
         label.scale = TRUE, mar = c(8, 8, 8, 8))
```

# With numeric data
```{r}
df.matched[, names(df.matched) %like% "Q35|Q36"] <- data.frame(lapply(df.matched[, names(df.matched) %like% "Q35|Q36"], function(x) as.numeric(x)))

fit <- sem(mod, unique(df.matched[, names(df.matched) %like% "Q35|Q36"]))
summary(fit, standardized = TRUE, fit.measures = TRUE, modindices = TRUE)
semPaths(fit, whatLabels = 'std', edge.color = 'black', curve = 2, residuals = FALSE, label.scale = TRUE, mar = c(8, 8, 8, 8))
```

# EFA
```{r}
CIS.cols <- c('Q35_1', 'Q35_2', 'Q35_3', 'Q35_4', 'Q35_5', 'Q36_1', 'Q36_2', 'Q36_3', 
              'Q36_4', 'Q36_5', 'Q36_6')

fa.parallel(unique(df.matched[, CIS.cols]))
fit <- fa(unique(df.matched[, CIS.cols]), 2)
fit
fa.diagram(fit)
```

# CFA with model suggested by EFA (only minor changes that I think are theoretically justifiable)
```{r}
mod <- '
  agency =~ Q35_1 + Q35_2 + Q35_3 + Q35_4 + Q36_6 + Q35_5
  modeling =~ Q36_1 + Q36_2 + Q36_4
'

fit <- sem(mod, unique(df.matched[, names(df.matched) %like% "Q35|Q36"]))
summary(fit, standardized = TRUE, fit.measures = TRUE, modindices = TRUE)
semPaths(fit, whatLabels = 'std', edge.color = 'black', curve = 2, residuals = FALSE, 
         label.scale = TRUE, mar = c(8, 8, 8, 8))
```
*This seems like a good model to move forward with. We drop two items from the modeling factor. For the record, I'm okay with adding them back in, but they will increase our variance maybe more than we can afford.*

# Larger SEM model with latent class variables as mediating variables in the analysis
```{r}
df.matched <- df.matched %>%
  mutate(Lab.goal.skills = 1 * (Lab.goal == 'Skills'),
         Lab.goal.both = 1 * (Lab.goal == 'Both'),
         Lab.goal.concepts = 1 * (Lab.goal == 'Concepts'),
         Lab.level.BFY = 1 * (Lab.level == 'BFY'),
         Lab.level.FY.Calc = 1 * (Lab.level == 'FY.Calc'),
         Lab.level.BFY = 1 * (Lab.level == 'FY.Alg'))

mod.sem <- '
  level: 1
    student.score.post ~ student.score.pre
  level: 2
    agency =~ Q35_1 + Q35_2 + Q35_3 + Q35_4 + Q35_5 + Q36_6
    modeling =~ Q36_1 + Q36_2 + Q36_4 + Q36_5

    agency ~ Lab.goal.skills + Lab.goal.both
    modeling ~ Lab.goal.skills + Lab.goal.both
    agency ~~ modeling

    student.score.post ~ agency + modeling + Lab.goal.skills + Lab.goal.both
'

fit <- sem(mod.sem, data = df.matched, cluster = "ResponseId.CIS")
summary(fit, standardized = TRUE, fit.measures = TRUE, modindices = TRUE)
standardizedsolution(fit)
#resid(fit, type = "cor")
```


