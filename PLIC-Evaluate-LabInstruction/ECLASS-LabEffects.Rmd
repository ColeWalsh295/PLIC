# Load necessary packages
```{r, results = 'hide', message = FALSE, warning = FALSE}
library(tidyverse)
library(data.table)
library(reshape2)
library(ggpubr)
library(lmerTest)
library(stargazer)
library(lavaan)
library(semPlot)
theme_set(theme_classic(base_size = 10))
```

# Scoring/cleaning functions
```{r}
Read.Score <- function(file){
  dt <- fread(file)
  answers.cols <- names(dt)[grep('(a|b)$', names(dt))]
  
  dt[, (answers.cols) := lapply(.SD, function(x) case_when(x == 5 ~ 1,
                                                           x == 1 ~ -1,
                                                           TRUE ~ 0)),
     .SDcols = answers.cols]
  df <- dt[, -c('q40a', 'q40b')]

  df$student.score <- rowSums(df %>% select(grep("a$", names(.))))
  df$expert.score <- rowSums(df %>% select(grep("b$", names(.))))
  
  return(df)
}

Read.duplicate.cis <- function(file){
  cis.df <- read.csv(file)
  
  cis.noInfo <- cis.df[(cis.df$Q33 == '') | is.na(cis.df$Q33),]
  cis.FullInfo <- cis.df[(cis.df$Q33 != '') & !is.na(cis.df$Q33),]
  
  original.cols <- c('Q5', 'Q52',	'Q53', 'Q27', 'Q6',	'Q11', 'Q19',	'Q20', 'StartDate',
                     'anon_instructor_id', 'ResponseId', 'pre_survey_id', 'post_survey_id')

  cis.noInfo <- left_join(cis.noInfo, cis.FullInfo, 
                          by = c('anon_university_id', 'Q18'), 
                          suffix = c('.original', '.copy')) %>%
    select(anon_university_id, Q18, Q15.copy,	Q21.copy,	Q22_1.copy,	Q22_2.copy,	Q23.copy, 
           Q29.copy, grep('Q(3|4)\\d_?\\d?\\.copy', names(.)), 
           paste(original.cols, '.original', sep = '')) %>%
    filter(!duplicated(ResponseId.original) & !is.na(ResponseId.original)) %>%
    `colnames<-`(unlist(lapply(names(.), function (x) strsplit(x, '\\.')[[1]][1])))
  
  cis.df <- rbind(cis.FullInfo, cis.noInfo[, names(cis.df)])
  return(cis.df)
}
```

# Read, score, and match
```{r}
cis.df <- Read.duplicate.cis('C:/Users/Cole/Documents/GRA_Summer2020/eclass-public-master/anon_cis.csv')

#cis.df <- read.csv('C:/Users/Cole/Documents/GRA_Summer2020/eclass-public-master/anon_cis.csv')

pre.df <- Read.Score('C:/Users/Cole/Documents/GRA_Summer2020/eclass-public-master/anon_pre.csv')

cis.pre.df <- right_join(cis.df, pre.df, by = c('pre_survey_id' = 'survey_id'))

post.df <- Read.Score('C:/Users/Cole/Documents/GRA_Summer2020/eclass-public-master/anon_post.csv')

full.df <- full_join(cis.pre.df, post.df, 
                     by = c('post_survey_id' = 'survey_id', 
                            'anon_student_id'), suffix = c('.pre', '.post'))

print('Total # of students in dataset...')
nrow(full.df)

print('Total # of classes in dataset...')
length(unique(full.df$ResponseId))

df.matched <- full.df %>%
  filter(!is.na(student.score.pre) & !is.na(student.score.post))

print('# of students in matched dataset...')
nrow(df.matched)

print('# of classes in matched dataset...')
length(unique(df.matched$ResponseId))
```

# Data processing
```{r}
# Replace declared major with intended major in cases where students intend to switch
df.matched[is.na(df.matched$Q48) | (df.matched$Q48 == 0), 
           'Q48'] <- df.matched[is.na(df.matched$Q48) | (df.matched$Q48 == 0), 'Q47']

# When students select multiple race/ethnicity boxes, set to group with minimum membership
colSums(df.matched[, c('Q52_1', 'Q52_2', 'Q52_3', 'Q52_4', 'Q52_5', 'Q52_6', 'Q52_7')], na.rm = TRUE)

# Ethnicity set priority = Native Hawaiian/pacific islander, American indian/Alaska native, Other race/ethnicity, Black/African american, Hispanic/latinx, Asian, White

df.matched <- df.matched %>%
  mutate(Major = case_when(
    Q48 == 1 ~ 'Physics',
    Q48 == 2 ~ 'Chemistry',
    Q48 == 3 ~ 'Biochemistry',
    Q48 == 4 ~ 'Biology',
    Q48 == 5 ~ 'Engineering',
    Q48 == 6 ~ 'Engineering Physics',
    Q48 == 7 ~ 'Astronomy',
    Q48 == 8 ~ 'Astrophysics',
    Q48 == 9 ~ 'Geology/geophysics',
    Q48 == 10 ~ 'Math/applied math',
    Q48 == 11 ~ 'Computer science',
    Q48 == 12 ~ 'Physiology',
    Q48 == 13 ~ 'Other science',
    Q48 == 14 ~ 'Non-science',
    Q48 == 15 ~ 'Open/undeclared',
    TRUE ~ NA_character_
  ),
  Gender = case_when(
    Q54 == 1 ~ 'Woman',
    Q54 == 2 ~ 'Man',
    Q54 == 3 ~ 'Other',
    TRUE ~ NA_character_
  ),
  Race.ethnicity = case_when(
    Q52_5 == 1 ~ 'Native Hawaiian or Pacific islander',
    Q52_1 == 1 ~ 'American indian or Alaska native',
    Q52_7 == 1 ~ 'Other',
    Q52_3 == 1 ~ 'Black or African american',
    Q52_4 == 1 ~ 'Hispanic/latinx',
    Q52_2 == 1 ~ 'Asian',
    Q52_6 == 1 ~ 'White',
    TRUE ~ NA_character_
  ),
  Lab.goal = Q33,
  Lab.level = case_when(
    Q18 == 'Beyond the first year lab' ~ 'BFY',
    Q27 == 'Calculus-based' ~ 'FY.calc',
    Q27 == 'Algebra-based' ~ 'FY.alg',
    TRUE ~ NA_character_
  ))
```

# Data filtering
```{r}
# Remove whole classes without goal and/or level information
df.matched <- df.matched %>%
  filter(!is.na(Lab.goal) & !is.na(Lab.level))

print('# of remaining students in matched dataset...')
nrow(df.matched)

print('# of remaining classes in matched dataset...')
length(unique(df.matched$ResponseId))

# Remove students without full race/ethnicity, gender, and major information
df.matched <- df.matched %>%
  filter(!is.na(Major) & !is.na(Gender) & !is.na(Race.ethnicity))

print('# of remaining students in matched dataset...')
nrow(df.matched)

print('# of remaining classes in matched dataset...')
length(unique(df.matched$ResponseId))
```

# Descriptive statistics
```{r}
plot.pre.post <- function(df, var){
  print(table(df[, var]))
  df.matched.long <- reshape2::melt(df, measure.vars = c('student.score.pre', 
                                                       'student.score.post'))
  
  p <- ggplot(df.matched.long, aes_string(x = var, y = 'value', group = 'variable', color = 'variable'))
  add_summary(p, fun = 'mean_se', group = c('variable')) +
    ylab('Score') +
    scale_color_manual(labels = c('pre', 'post'), values = c('#2271B2', '#D55E00')) +
    theme(axis.text.x = element_text(angle = 90))
}

plot.pre.post(df.matched, 'Major')
plot.pre.post(df.matched, 'Gender')
plot.pre.post(df.matched, 'Race.ethnicity')
plot.pre.post(df.matched, 'Lab.goal')
```

# Collapse data
```{r}

```


# Mixed-effects models
```{r}
summary(lmer(student.score.post ~ student.score.pre + Lab.goal + Lab.level + Major + 
               Gender + Race.ethnicity + (1 | ResponseId), df.matched))
```

