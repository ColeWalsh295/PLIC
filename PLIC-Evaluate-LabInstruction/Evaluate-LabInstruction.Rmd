```{r}
library(broom.mixed)
library(tidyverse)
library(data.table)
source('C:/Users/Cole/Documents/GitHub/PLIC/Process-Merge-Concat/PLIC_DataProcessing.R')
library(effsize)
library(lsr)
library(lme4)
library(lmerTest)
library(MuMIn)
library(stargazer)
library(lavaan)
library(semPlot)
library(sjPlot)
theme_set(theme_classic(base_size = 10))
```

**Import complete data**
```{r}
df <- fread('C:/Users/Cole/Documents/PLIC_DATA/Collective_Surveys/Complete/Complete_Concat.csv') %>%
  Clean.PLIC(., Matched = TRUE, Collapse.vars = FALSE) %>%
  Merge.CIS(., Matched = TRUE) %>%
  filter((Lab_Level == 'Intro-Algebra') | (Lab_Level == 'Intro-Calculus'))

df %>%
  summarize(N.Students = nrow(.), N.Classes = length(unique(.[, 'Class_ID'])), N.Schools = length(unique(.[, 'School'])))

# unique(df$School)

# Gender non-binaries?
table(df$Gender, exclude = NULL)
```

**Perform student/class filtering**
```{r}
df <- fread('C:/Users/Cole/Documents/PLIC_DATA/Collective_Surveys/Complete/Complete_Concat.csv') %>%
  Clean.PLIC(., Matched = TRUE) %>%
  Merge.CIS(., Matched = TRUE) %>%
  filter(Survey_x == 'C' | Survey_y == 'C') %>%
  filter((Lab_Level == 'Intro-Algebra') | (Lab_Level == 'Intro-Calculus'))

df %>%
  summarize(N.Students = nrow(.), N.Classes = length(unique(.[, 'Class_ID'])), N.Schools = length(unique(.[, 'School'])))

# Filter by student demographics
df <- df %>%
  filter(!is.na(Gender) & !is.na(Ethnicity) & !is.na(Major))
df %>%
  summarize(N.Students = nrow(.), N.Classes = length(unique(.[, 'Class_ID'])), N.Schools = length(unique(.[, 'School'])))

df <- data.table(df)[, `:=`(N.students = .N, pre.rate = sum(Survey_x == 'C')/.N, 
                            post.rate = sum(Survey_y == 'C')/.N), 
                     .(Class_ID)]

data.frame(df[pre.rate == 0]) %>%
  summarize(N.Classes = length(unique(.[, 'Class_ID'])))

# df[post.rate == 0 & !duplicated(Class_ID)]$Class_ID

data.frame(df[post.rate == 0]) %>%
  summarize(N.Classes = length(unique(.[, 'Class_ID'])))

df <- df[pre.rate >= 0.4 & post.rate >= 0.4]

data.frame(df) %>%
  summarize(N.Students = nrow(.), N.Classes = length(unique(.[, 'Class_ID'])), N.Schools = length(unique(.[, 'School'])))

df <- df[Survey_x == 'C' & Survey_y == 'C']

data.frame(df) %>%
  summarize(N.Students = nrow(.), N.Classes = length(unique(.[, 'Class_ID'])), N.Schools = length(unique(.[, 'School'])))

table(df[!duplicated(df$School),]$Institution_Type, exclude = NULL)
table(df[!duplicated(df$Class_ID),]$Lab_Level, exclude = NULL)
table(df[!duplicated(df$Class_ID),]$Lab_Purpose, exclude = NULL)
```

**Mutate class/student variables**
```{r}
df <- df %>%
  mutate(ender = relevel(as.factor(Gender), ref = 'Men'),
         URM_Status = relevel(as.factor(URM_Status), ref = 'URM'),
         Major = relevel(as.factor(Major), ref = 'Other'),
         LabLevel = relevel(as.factor(Lab_Level), ref = 'Intro-Algebra'),
         Lab_Purpose = relevel(as.factor(Lab_Purpose), ref = 'Reinforce physics concepts'))

df.Centered <- Create.Class.Variables(df)

df.Centered$GenW <- df.Centered$Gender == 'Women'
df.Centered$MajorEng <- df.Centered$Major == 'Engineering'
df.Centered$MajorPhys <- df.Centered$Major == 'Physics'
```

**Demographic Breakdown**
```{r}
table(df.Centered$Gender, exclude = NULL)
table(df.Centered$URM_Status)
table(df.Centered$Major)
table(df.Centered$Lab_Level, exclude = NULL)
table(df.Centered$Lab_Purpose, exclude = NULL)
table(df.Centered$Gender, df.Centered$Lab_Level)
table(df.Centered$URM_Status, df.Centered$Lab_Level)
table(df.Centered$Major, df.Centered$Lab_Level)
table(df.Centered$Gender, df.Centered$Lab_Purpose)
table(df.Centered$URM_Status, df.Centered$Lab_Purpose)
table(df.Centered$Major, df.Centered$Lab_Purpose)
```

**Descriptive Stats**
```{r}
Desc.stats <- function(df, var){
  df %>%
    group_by_(var) %>%
    summarize(n(), mean(PreScores), sd(PreScores)/sqrt(n()), mean(PostScores), sd(PostScores)/sqrt(n()))
}

Desc.stats(df.Centered, 'Gender')
Desc.stats(df.Centered, 'URM_Status')
Desc.stats(df.Centered, 'Major')
Desc.stats(df.Centered, 'Lab_Level')
Desc.stats(df.Centered, 'Lab_Purpose')
```

**LMER**
```{r}
mod.null <- lmer(PostScores ~ (1 | School/Class_ID), df.Centered)
summary(mod.null)
r.squaredGLMM(mod.null)

mod.main <- lmer(PostScores ~ PreScores.cwc + PreScores.cm + Gender + URM_Status + Major + Lab_Purpose + Lab_Level + (1 | School/Class_ID), df.Centered)
summary(mod.main)
r.squaredGLMM(mod.main)

mod.interaction <- lmer(PostScores ~ PreScores.cwc + PreScores.cm + (Gender + URM_Status) * Lab_Purpose + Major + Lab_Level + (1 | School/Class_ID), df.Centered)
summary(mod.interaction)
r.squaredGLMM(mod.interaction)

class(mod.null) <- "lmerMod"
class(mod.main) <- "lmerMod"
class(mod.interaction) <- "lmerMod"
stargazer(mod.null, mod.main, mod.interaction, star.cutoffs = c(0.05, 0.01, 0.001), intercept.bottom = FALSE, out = 'Results.tex', intercept.top = TRUE, omit.stat = 'all')
```

**Coefs plot**
```{r}
plot_model(mod.interaction, type = 'eff', terms = c('URM_Status', 'Lab_Purpose'), dot.size = 6, line.size = 1, ci.lvl = 0.67, title = '')
```

**SEM Analysis**
```{r}
model <- '
  level: 1
  # measurement model
    Conf =~ Q7a_10 + Q7a_11  + Q7a_13
    Att =~ Q7b_1 + Q7b_2 + Q7b_3 + Q7b_4
    Eff =~ Q7c_1 + Q7c_2 + Q7b_3
  # regressions
    Conf ~ GenW + URM_Status
    Att ~ GenW + URM_Status
    Eff ~ GenW + URM_Status
    TotalScores ~ GenW + URM_Status + MajorEng + MajorPhys + Conf + Att + Eff
  level: 2
    TotalScores ~ Lab_Level
'

#fit <- sem(model, data = PLIC.PreOnly)
fit <- sem(model, data = df.Centered, cluster = 'Class_ID')
summary(fit, standardized = TRUE, fit.measures = TRUE, modindices = TRUE)
# semPaths(fit, whatLabels = 'stand')
```

**DIF Analysis**
```{r}
library(difR)
library(infotheo)

df.dicho <- df.Centered %>%
  mutate(Q1Bs.med = 1 * (Q1Bs >= median(Q1Bs)),
         Q1Ds.med = 1 * (Q1Ds >= median(Q1Ds)),
         Q1Es.med = 1 * (Q1Es >= median(Q1Es)),
         Q2Bs.med = 1 * (Q2Bs >= median(Q2Bs)),
         Q2Ds.med = 1 * (Q2Ds >= median(Q2Ds)),
         Q2Es.med = 1 * (Q2Es >= median(Q2Es)),
         Q3Bs.med = 1 * (Q3Bs >= median(Q3Bs)),
         Q3Ds.med = 1 * (Q3Ds >= median(Q3Ds)),
         Q3Es.med = 1 * (Q3Es >= median(Q3Es)),
         Q4Bs.med = 1 * (Q4Bs >= median(Q4Bs)))

difMH(df.dicho[, c('Q1Bs.med', 'Q1Ds.med', 'Q1Es.med', 'Q2Bs.med', 'Q2Ds.med', 'Q2Es.med', 'Q3Bs.med',
                      'Q3Ds.med', 'Q3Es.med', 'Q4Bs.med')], group = df.dicho$URM_Status, focal.name = 'URM',
      match = discretize(df.dicho$PreScores)$X, p.adjust.method = 'holm')
```


**MC Analysis**
```{r}
df.MC <- df.Centered %>%
  filter(!is.na(Q3c) & !is.na(Q4a)) %>%
  mutate(Q3C.Score = ifelse(Q3c == 2, 1, 0),
         Q4A.Score = ifelse(Q4a == 2, 1, 0),
         MC.Score = Q3C.Score + Q4A.Score)

t.test(df.MC$MC.Score ~ df.MC$Gender)
t.test(df.MC$MC.Score ~ df.MC$URM_Status)
```

**Likert Analysis**
```{r}
df.Likert <- df.Centered %>%
  filter(!is.na(Q2c) & !is.na(Q3a)) %>%
  mutate(Q2C.Score = case_when(
    Q2c > 3 ~ 1,
    Q2c < 3 ~ -1,
    Q2c == 3 ~ 0
  ),
  Q3A.Score = case_when(
    Q3a < 3 ~ 1,
    Q3a > 3 ~ -1,
    Q3a == 3 ~ 0
  ),
  Likert.Score = Q2C.Score + Q3A.Score)

t.test(df.Likert$Likert.Score ~ df.Likert$Gender)
t.test(df.Likert$Likert.Score ~ df.Likert$URM_Status)
```

**FR Analysis**
```{r}
df.FR <- df.Student %>%
  filter(Survey == 'F') %>%
  filter(TotalScores != 0)

hist(df.FR$TotalScores, breaks = 10)

t.test(df.FR$TotalScores ~ df.FR$Gender)
t.test(df.FR$TotalScores ~ df.FR$URM_Status)

cohen.d(df.FR$TotalScores ~ df.FR$Gender)
cohen.d(df.FR$TotalScores ~ df.FR$URM_Status)
```